@{
    ViewBag.Title = "Milestone Management • Project Management System";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="container mt-5">
    <div class="text-center">
        <h2 class="milestone-title">Checklist and Milestone <br />Management</h2>
        <p class="text-muted">Easily create and manage project milestones.</p>
    </div>

    <div class="form-group mb-4">
        <label for="divisionDropdown" class="form-label fw-bold">Division</label>
        <select id="divisionDropdown" class="form-select custom-dropdown" required>
            <option value="">Choose Division</option>
            @if (ViewBag.Divisions != null)
            {
                foreach (var division in ViewBag.Divisions as List<SelectListItem>)
                {
                    <option value="@division.Value">@division.Text</option>
                }
            }
        </select>
    </div>

    <button id="addMilestoneBtn" class="btn btn-violet btn-lg">
        <i class="fas fa-plus"></i> Create
    </button>

    <div class="table-responsive mt-4">
        <table class="table table-bordered milestone-table" id="milestoneTable">
            <thead class="table-header">
                <tr>
                    <th>Division</th>
                    <th>Milestones</th>
                    <th>Requirements</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .container {
        max-width: 1000px;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.1);
    }


    .milestone-title {
        /*font-size: 2rem;
        font-weight: 700;*/
        color: #6f42c1 !important;
        margin-bottom: 10px;
    }

    .custom-dropdown {
        /*border: 2px solid #6f42c1;*/
        border-radius: 8px;
        padding: 10px;
        font-size: 16px;
    }

    .btn-violet {
        background-color: #6f42c1;
        color: white;
        font-weight: 600;
        border-radius: 8px;
        padding: 12px 24px;
        transition: 0.3s ease-in-out;
        font-size: 16px;
    }

    .btn-violet:hover {
        background-color: #5a32a3;
    }

    .milestone-table {
        width: 100%;
        text-align: center;
        border-collapse: collapse;
    }

    .milestone-table th {
        background-color: #4C2A85;
        color: white;
        font-size: 16px;
        /*font-weight: bold;*/
        padding: 12px;
        vertical-align: middle;
    }

    .milestone-table td {
        padding: 12px;
        font-size: 15px;
        vertical-align: middle;
    }

    .milestone-table tbody tr:nth-child(odd) {
        background-color: #f9f9f9;
    }

    .milestone-table tbody tr:hover {
        background-color: #f1f1f1;
    }

    .action-btns .btn {
        margin: 2px;
        font-size: 14px;
        padding: 8px 12px;
    }

    @@media (max-width: 768px) {
        .container {
            width: 95%;
            padding: 20px;
        }

        .btn-violet {
            width: 100%;
        }
    }
</style>

<script>
    $(document).ready(function () {
        let table = $('#milestoneTable').DataTable({
            "paging": true,
            "searching": true,
            "ordering": false,
            "info": true
        });

        function loadDivisions() {
            $.get('/Admin/GetSavedDivisions', function (data) {
                table.clear();
                data.forEach(function (division) {
                    table.row.add([
                        `<strong>${division.DivisionName}</strong>`,
                        division.NumberOfMilestones,
                        division.NumberOfRequirements,
                        `<div class="action-btns">
                            <a href="/Admin/CreateChecklist?divisionId=${division.DivisionID}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus"></i> Add
                            </a>
                            <a href="/Admin/CreateChecklist?divisionId=${division.DivisionID}" class="btn btn-warning btn-sm">
                                <i class="fas fa-edit"></i> Update
                            </a>
                            <button class="btn btn-danger btn-sm removeMilestone" data-id="${division.DivisionID}">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                            <button class="btn btn-info btn-sm previewMilestone" data-id="${division.DivisionID}">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </div>`
                    ]).draw(false);
                });
            });
        }

        loadDivisions(); 

        $('#addMilestoneBtn').click(function () {
            let divisionId = $('#divisionDropdown').val();
            let divisionName = $('#divisionDropdown option:selected').text();

            if (!divisionId) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Select a Division!',
                    text: 'Please select a division before creating a milestone.',
                    confirmButtonColor: '#6f42c1'
                });
                return;
            }

            $.post('/Admin/SaveDivision', { divisionId: divisionId }, function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: response.message,
                        confirmButtonColor: '#6f42c1'
                    });
                    loadDivisions();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error!',
                        text: response.message,
                        confirmButtonColor: '#6f42c1'
                    });
                }
            });
        });

        $(document).on('click', '.removeMilestone', function () {
            let divisionId = $(this).data('id');

            Swal.fire({
                title: 'Are you sure?',
                text: "This will remove the division from the table",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.post('/Admin/HideDivision', { divisionId: divisionId }, function (response) {
                        if (response.success) {
                            Swal.fire('Removed!', 'Successfully removed.', 'success');
                            loadDivisions();
                        } else {
                            Swal.fire('Error!', response.message, 'error');
                        }
                    });
                }
            });
        });
    });
</script>
